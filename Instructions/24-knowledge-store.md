---
lab:
    title: 'Azure Cognitive Search 用ナレッジ ストアの作成'
    module: 'モジュール 12 - ナレッジ マイニング ソリューションの作成'
---

# Azure Cognitive Search 用ナレッジ ストアの作成

Azure Cognitive Search は、コグニティブ スキルの強化パイプラインを使用して、ドキュメントから AI で生成されたフィールドを抽出し、検索インデックスに含めます。インデックスはインデックス作成プロセスからの主要な出力と見なされる場合がありますが、インデックスに含まれる強化されたデータは他の方法でも役立つ場合があります。例:

- インデックスは基本的に JSON オブジェクトのコレクションであり、それぞれがインデックス付きレコードを表すため、Azure Data Factory などのツールを使用してデータ オーケストレーション プロセスに統合するために、オブジェクトを JSON ファイルとしてエクスポートすると便利な場合があります。
- Microsoft Power BI などのツールを使用して分析およびレポートするために、インデックス レコードをテーブルのリレーショナル スキーマに正規化することをお勧めします。
- インデックス作成プロセス中にドキュメントから埋め込み画像を抽出したら、それらの画像をファイルとして保存することをお勧めします。

この演習では、パンフレットやホテルのレビューの情報を使用して顧客が旅行を計画できるようにする架空の旅行代理店である *Margie'sTravel* のナレッジ ストアを実装します。

## このコースのリポジトリを複製する

**AI-102-AIEngineer** コード リポジトリをこのラボで作業している環境に既に複製している場合は、Visual Studio Code で開きます。それ以外の場合は、次の手順に従って今すぐ複製してください。

1. Visual Studio Code を起動します。
2. パレットを開き (SHIFT+CTRL+P)、**Git: Clone** コマンドを実行して、`https://github.com/MicrosoftLearning/AI-102JA-Designing-and-Implementing-a-Microsoft-Azure-AI-Solution` リポジトリをローカル フォルダーに複製します (どのフォルダーでもかまいません)。
3. リポジトリを複製したら、Visual Studio Code でフォルダーを開きます。
4. リポジトリ内の C# コード プロジェクトをサポートするために追加のファイルがインストールされるまで待ちます。

    > **注**: ビルドとデバッグに必要なアセットを追加するように求められた場合は、**「今はしない」** を選択します。

## Azure リソースを作成する

> **注**: 以前に **[Azure Cognitive Search ソリューションの作成] (22-azure-search.md)** の演習を完了し、サブスクリプションにこれらの Azure リソースが残っている場合は、このセクションをスキップして、**「検索ソリューションの作成」** セクションから開始できます。それ以外の場合は、以下の手順に従って、必要な Azure リソースをプロビジョニングします。

1. 新しい Wev ブラウザー、`https://portal.azure.com` で Azure portalを開き、Azure サブスクリプションに関連付けられている Microsoft アカウントを使用してサインインします。
2. サブスクリプションの**リソース グループ**を表示します。
3. リソース グループが提供されている制限付きサブスクリプションを使用している場合は、リソース グループを選択してそのプロパティを表示します。それ以外の場合は、選択した名前で新しいリソース グループを作成し、作成されたらそのグループに移動します。
4. リソース グループの **「概要」** ページで、**サブスクリプション ID** と**場所**をメモします。これらの値は、後続の手順でリソース グループの名前とともに必要になります。
5. Visual Studio Codeで、**24-knowledge-store** フォルダーを展開し、**setup.cmd** を選択します。このバッチ スクリプトを使用して、必要な Azure リソースを作成するために必要な Azure コマンド ライン インターフェイス (CLI) コマンドを実行します。
6. **24-knowledge-store** フォルダーを右クリックし、**「統合ターミナルで開く」** を選択します。
7. 「ターミナル」 ペインで、次のコマンドを入力して、Azure サブスクリプションへの認証済み接続を確立します。

    ```
    az login --output none
    ```

8. プロンプトが表示されたら、Azure サブスクリプションにサインインします。次に、Visual Studio Code に戻り、サインイン プロセスが完了するのを待ちます。
9. 次のコマンドを実行して、Azure の場所を一覧表示します。

    ```
    az account list-locations -o table
    ```

10. 出力で、リソース グループの場所に対応する **Name** 値を見つけます (たとえば、*米国東部*の場合、対応する名前は *eastus* です)。
11. **setup.cmd** スクリプトで、**subscription_id**、**resource_group**、および **location** 変数の宣言を、サブスクリプション ID、リソース グループ名、および場所名に適切な値で変更します。その後、変更を保存します。
12. **24-knowledge-store** フォルダーのターミナルで、次のコマンドを入力してスクリプトを実行します。

    ```
    setup
    ```
    > **注**: Search CLI モジュールはプレビュー中であり、*- R実行中*のプロセスでスタックする可能性があります。これが 2 分以上続く場合は、CTRL+C を押して長時間実行中の操作をキャンセルし、スクリプトを終了するかどうかを尋ねられたら **N** を選択します。その後、正常に完了するはずです。
    >
    > スクリプトが失敗した場合は、正しい変数名で保存したことを確認して、再試行してください。

13. スクリプトが完了したら、表示される出力を確認し、Azure リソースに関する次の情報をメモします (これらの値は後で必要になります)。
    - ストレージ アカウント名
    - ストレージ接続文字列
    - Cognitive Services アカウント
    - Cognitive Services キー
    - 検索サービス エンドポイント
    - 検索サービス管理者キー
    - 検索サービス クエリ キー

14. Azure portal で、リソースグループを更新し、Azure Storage アカウント、Azure Cognitive Services リソース、および Azure Cognitive Search リソースが含まれていることを確認します。

## 検索ソリューションの作成

必要な Azure リソースが揃ったので、次のコンポーネントで構成される検索ソリューションを作成できます。

- Azure ストレージ コンテナー内のドキュメントを参照する**データ ソース**。
- ドキュメントから AI で生成されたフィールドを抽出するスキルの強化パイプラインを定義する**スキルセット**。スキルセットは、*ナレッジ ストア*で生成される*予測*も定義します。
- 検索可能なドキュメントレコードのセットを定義する**インデックス**。
- データ ソースからドキュメントを抽出し、スキル セットを適用して、インデックスにデータを入力する**インデクサー**。インデックス作成のプロセスは、ナレッジ ストアのスキル セットで定義された予測も保持します。

この演習では、Azure Cognitive Search REST インターフェイスを使用して、JSON リクエストを送信することでこれらのコンポーネントを作成します。

### REST 操作用の JSON の準備

REST インターフェイスを使用して、Azure CognitiveSearch コンポーネントの JSON 定義を送信します。

1. Visual Studio Code の **24-knowledge-store** フォルダーで、**create-search** フォルダーを展開し、**data_source.json** を選択します。このファイルには、**margies-knowledge-data** という名前のデータソースの JSON 定義が含まれています。
2. **YOUR_CONNECTION_STRING** プレースホルダーを Azure ストレージアカウントの接続文字列に置き換えます。これは次のようになります。

    ```
    DefaultEndpointsProtocol=https;AccountName=ai102str123;AccountKey=12345abcdefg...==;EndpointSuffix=core.windows.net
    ```

    *接続文字列は、Azureポータルのストレージアカウントの 「**アクセスキー**」 ページにあります。*

3. 更新された JSON ファイルを保存して閉じます。
4. **create-search** フォルダーで、**skillset.json** を開きます。このファイルには、**margies-knowledge-skillset** という名前のスキルセットの JSON 定義が含まれています。
5. スキルセット定義の上部にある **cognitiveServices** 要素で、**YOUR_COGNITIVE_SERVICES_KEY** プレースホルダーを Cognitive Services サービスリ ソースのいずれかのキーに置き換えます。

    *キーは、Azure portal の Cognitive Services リソースの **「キーとエンドポイント」** ページにあります。*

6. スキルセット内のスキルのコレクションの最後に、**define-projection** という名前の **Microsoft.Skills.Util.ShaperSkill** スキルを見つけます。このスキルは、インデクサーによって処理される各ドキュメントのナレッジ ストアにパイプラインが保持されるプロジェクションに使用される、強化されたデータの JSON 構造を定義します。
7. スキル セット ファイルの下部に、ナレッジ ストア定義が含まれていることを確認します。**ナレッジ ストア**定義には、ナレッジ ストアが作成される Azure Storage アカウントの接続文字列と、**プロジェクション**のコレクションが含まれています。このスキル セットには、次の 3 つの*プロジェクション グループ*が含まれます。
    - スキル セット内のシェイパー スキルの **knowledge_projection** 出力に基づく*オブジェクト* プロジェクションを含むグループ。
    - ドキュメントから抽出された画像データの**normalized_images**コレクションに基づく*ファイル* プロジェクションを含むグループ。
    - 次の*テーブル* プロジェクションを含むグループ。
        - **KeyPhrases**: 自動生成されたキー列と、シェーパー スキルの **knowledge_projection/key_phrases/** コレクション出力にマップされた **keyPhrase** 列が含まれます。
        - **Locations**: 自動生成されたキー列と、シェーパー スキルの **knowledge_projection/key_phrases/** コレクション出力にマップされた **location** 列が含まれます。
        - **ImageTags**: 自動生成されたキー列と、シェーパー スキルの **knowledge_projection/image_tags/** コレクション出力にマップされた **tag** 列が含まれます。
        - **Docs**: 自動生成されたキー列と、テーブルにまだ割り当てられていないシェイパー スキルからのすべての **knowledge_projection** 出力値が含まれます。
8. **storageConnectionString** 値の **YOUR_CONNECTION_STRING** プレースホルダーを、ストレージ アカウントの接続文字列に置き換えます。
9. 更新された JSON ファイルを保存して閉じます。
10. **create-search** フォルダーで、**index.json**を開きます。このファイルには、**margies-knowledge-index** という名前のインデックスの JSON 定義が含まれています。
11. インデックスの JSON を確認し、変更を加えずにファイルを閉じます。
12. **create-search** フォルダーで、**indexer.json**を開きます。このファイルには、**margies-knowledge-indexer** という名前のインデクサーの JSON 定義が含まれています。
13. インデクサーの JSON を確認し、変更を加えずにファイルを閉じます。

### REST リクエストの送信

検索ソリューションコンポーネントを定義する JSON オブジェクトを準備したので、JSON ドキュメントを REST インターフェイスに送信して作成できます。

1. **create-search** フォルダーで、**create-search.cmd**.を開きます。このバッチ スクリプトは、cURL ユーティリティを使用して、Azure Cognitive Search リソースの REST インターフェイスに JSON 定義を送信します。
2. **YOUR_SEARCH_URL** 変数と **YOUR_ADMIN_KEY** 変数のプレースホルダーを、Azure Cognitive Search リソースの **Url** と**管理キー**の 1 つに置き換えます。

    *これらの値は、Azure portal の Azure Cognitive Search リソースの **「概要」** ページと **「キー」** ページにあります。*

3. 更新したバッチファイルを保存します。
4. **create-search** フォルダーを右クリックし、**「統合ターミナルで開く」** を選択します。
5. **create-search** フォルダーのターミナルペインで、次のコマンドを入力してバッチ スクリプトを実行します。

    ```
    create-search
    ```

6. スクリプトが完了したら、Azure portal の Azure Cognitive Search リソースのページで、**「インデクサー」** ページを選択し、インデックス作成プロセスが完了するのを待ちます。

    ***「更新」** を選択して、インデックス作成操作の進行状況を追跡できます。完了するまでに 1 分ほどかかる場合があります。*

    > **ヒント**: スクリプトが失敗した場合は、**data_source.json** ファイルと **skillset.json** ファイル、および **create-search.cmd** ファイルに追加したプレースホルダーを確認してください。間違いを修正した後、スクリプトを再実行する前に、Azure portal のユーザー インターフェイスを使用して、検索リソースで作成されたコンポーネントを削除する必要がある場合があります。

## ナレッジストアの表示

スキル セットを使用してナレッジ ストアを作成するインデクサーを実行した後、インデックス作成プロセスによって抽出された強化されたデータは、ナレッジ ストアの予測に保持されます。

### オブジェクト プロジェクションの表示

Margie's Travel スキルセットで定義されている*オブジェクト* プロジェクションは、インデックス付けされた各ドキュメントの JSON ファイルで構成されています。これらのファイルは、スキル セット定義で指定された Azure Storage アカウントの BLOB コンテナーに格納されます。

1. Azure portal で、以前に作成した Azure Storage アカウントを表示します。
2. (左側のペインにある) **「ストレージエクスプローラー」** タブを選択して、Azure portal のストレージ エクスプローラー インターフェイスにストレージ アカウントを表示します。
2. **BLOB CONTAINERS** を展開して、ストレージ アカウントのコンテナーを表示します。ソース データが格納されている **margies**コンテナーに加えて、**margies-images** と **margies-knowledge** の 2 つの新しいコンテナがー必要です。これらは、インデックス作成プロセスによって作成されました。
3. **margies-knowledge** コンテナーを選択します。インデックス付きドキュメントごとにフォルダーが含まれている必要があります。
4. いずれかのフォルダーを開き、そこに含まれている **knowledge-projection.json** ファイルをダウンロードして開きます。各 JSON ファイルには、ここに示すようにスキル セットによって抽出された強化されたデータを含む、インデックス付きドキュメントの表現が含まれています。

```
{
    "file_id":"abcd1234....",
    "file_name":"Margies Travel Company Info.pdf",
    "url":"https://store....blob.core.windows.net/margies/...pdf",
    "language":"en",
    "sentiment":0.83164644241333008,
    "key_phrases":[
        "Margie’s Travel",
        "Margie's Travel",
        "best travel experts",
        "world-leading travel agency",
        "international reach"
        ],
    "locations":[
        "Dubai",
        "Las Vegas",
        "London",
        "New York",
        "San Francisco"
        ],
    "image_tags":[
        "outdoor",
        "tree",
        "plant",
        "palm"
        ]
}
```

このような*オブジェクト* プロジェクションを作成する機能により、エンタープライズ データ分析ソリューションに組み込むことができる強化されたデータ オブジェクトを生成できます。たとえば、JSON ファイルを Azure Data Factory パイプラインに取り込んで、さらに処理したり、データ ウェアハウスに読み込んだりできます。

### ファイル プロジェクションの表示

スキル セットで定義された*ファイル* プロジェクションは、インデックス作成プロセス中にドキュメントから抽出された各画像の JPEG ファイルを作成します。

1. Azure portal のストレージ エクスプローラー インターフェイスで、**margies-images** コンテナーを選択します。このコンテナーには、画像を含む各ドキュメントのフォルダーが含まれています。
2. いずれかのフォルダを開き、その内容を表示します。各フォルダには、少なくとも 1 つの \*.jpg ファイルが含まれています。
3. いずれかの画像ファイルを開いて、ドキュメントから抽出された画像が含まれていることを確認します。

このような*ファイル* プロジェクションを生成する機能により、インデックス作成は、大量のドキュメントから埋め込み画像を抽出する効率的な方法になります。

### テーブル プロジェクションの表示

スキル セットで定義された*テーブル* プロジェクションは、強化されたデータのリレーショナル スキーマを形成します。

1. Azure portal のストレージ エクスプローラー インターフェイスで、**TABLES** を展開します。
2. **Docs** テーブルを選択して、その列を表示します。列には、いくつかの標準の Azure Storage テーブル列が含まれています。これらを非表示にするには、**「列オプション」** を変更して、次の列のみを選択します。
    - **document_id** (インデックス作成プロセスによって自動的に生成されるキー列)
    - **file_id** (エンコードされたファイル URL)
    - **file_name** (ドキュメント メタデータから抽出されたファイル名)
    - **language** (ドキュメントが書き込まれる言語)
    - **sentiment** ドキュメントに対して計算されたセンチメントスコア。
    - **url** Azure ストレージ内のドキュメント BLOB の URL。
3. インデックス作成プロセスによって作成された他のテーブルを表示します。
    - **ImageTags** (グが表示されるドキュメントの **document_id** を持つ個々の画像タグごとの行が含まれます)。
    - **KeyPhrases** (フレーズが表示されるドキュメントの **document_id** を持つ個々のキーフレーズの行が含まれます)。
    - **Locations** (場所が表示されるドキュメントの **document_id** を含む個々の場所の行が含まれます)。

*テーブル* プロジェクションを作成する機能により、リレーショナル スキーマをクエリする分析およびレポート ソリューションを構築できます。たとえば、Microsoft PowerBI を使用します。自動生成されたキー列を使用して、クエリでテーブルを結合できます。たとえば、特定のドキュメントに記載されているすべての場所を返すことができます。

## 詳細

Azure Cognitive Search を使用したナレッジ ストアの作成の詳細については、[Azure Cognitive Search のドキュメント](https://docs.microsoft.com/azure/search/knowledge-store-concept-intro)を参照してください。
