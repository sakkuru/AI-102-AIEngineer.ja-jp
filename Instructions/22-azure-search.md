---
lab:
    title: 'Azure Cognitive Search ソリューションの作成'
    module: 'モジュール 12 - ナレッジ マイニング ソリューションの作成'
---

# Azure Cognitive Search ソリューションの作成

すべての組織は、意思決定、質問への回答、および効率的な機能を情報に依存しています。ほとんどの組織にとっての問題は、情報の不足ではなく、情報が格納されている大量のドキュメント、データベース、およびその他のソースから情報を見つけて抽出するという課題です。

たとえば、*Margie's Travel* が、世界中の都市への旅行の手配を専門とする旅行代理店であるとします。時を経て、パンフレットなどの資料や、お客様から寄せられたホテルのレビューなど、膨大な量の情報を蓄積してきました。このデータは、旅行代理店や顧客が旅行を計画する際の貴重な洞察の源ですが、膨大な量のデータにより、特定の顧客の質問に答えるための関連情報を見つけることが困難になる可能性があります。

この課題に対処するために、Margie'sTravel は Azure Cognitive Search を使用して、AI ベースのコグニティブ スキルを使用してドキュメントにインデックスを付け、強化して検索を容易にするソリューションを実装します。

## このコースのリポジトリを複製する

**AI-102-AIEngineer** コードのリポジトリをこのラボで作業している環境にまだ複製していない場合は、次の手順に従って複製してください。それ以外の場合は、複製されたフォルダーを Visual Studio Code で開きます。

1. Visual Studio Code を起動します。
2. パレットを開き (SHIFT+CTRL+P)、**Git: Clone** コマンドを実行して、 `https://github.com/MicrosoftLearning/AI-102JA-Designing-and-Implementing-a-Microsoft-Azure-AI-Solution` リポジトリをローカル フォルダーに複製します (どのフォルダーでもかまいません)。
3. リポジトリを複製したら、Visual Studio Code でフォルダーを開きます。
4. リポジトリ内の C# コード プロジェクトをサポートするために追加のファイルがインストールされるまで待ちます。

    > **注**: ビルドとデバッグに必要なアセットを追加するように求められた場合は、**「今はしない」** を選択します。

## Azure リソースを作成する

Margie'sTravel　用に作成するソリューションには、Azure　サブスクリプションに次のリソースが必要です。

- インデックス作成とクエリを管理する　**Azure Cognitive Search**　リソース。
- 検索ソリューションが、AI　によって生成された洞察でデータソース内のデータを充実させるために使用できるスキルに　AI　サービスを提供する **Cognitive Services** リソース。
- 検索対象のドキュメントが保存されている BLOB コンテナーを持つ **ストレージ アカウント**。

> **重要**: Azure Cognitive Search と Cognitive Services のリソースは同じ場所にある必要があります。

### Azure Cognitive Search リソースを作成する

1. ブラウザータブで、`https://portal.azure.com` で Azure portal を開き、Azure サブスクリプションに関連付けられている Microsoft アカウントを使用してサインインします。
2. **&#65291;「リソースの作成」** ボタンを選択し、*search*,を検索して、次の設定で **Azure Cognitive Search** リソースを作成します。
    - **サブスクリプション**: *お使いの Azure サブスクリプション*
    - **リソース グループ**: *新しいリソースグループを作成します（制限付きサブスクリプションを使用している場合は、新しいリソースを作成する権限がない可能性がありますリソースグループ-提供されているものを使用）*
    - **サービス名**: *一意の名前を入力します*
    - **場所**: *場所を選択します - Azure CognitiveSearchリソースとCognitiveServicesリソースは同じ場所にある必要があることに注意してください*
    - **価格レベル**: 基本

3. デプロイが完了するのを待ってから、デプロイされたリソースに移動します。
4. Azure portal の Azure Cognitive Search リソースのブレードの **「概要」** ページを確認します。ここでは、ビジュアル インターフェイスを使用して、検索ソリューションのさまざまなコンポーネントを作成、テスト、管理、および監視できます。データソース、インデックス、インデクサー、スキルセットを含みます。

### Cognitive Services リソースの作成

サブスクリプションにまだない場合は、**Cognitive Services** リソースをプロビジョニングする必要があります。検索ソリューションはこれを使用して、AI によって生成されたインサイトでデータストア内のデータを充実させます。

1. Azure portal　の 「ホーム」 ページに戻り、**&#65291;「リソースの作成」** ボタンを選択し、*Cognitive Services* を検索し、次の設定で **Cognitive Services** リソースを作成します。
    - **サブスクリプション**: *お使いの Azure サブスクリプション*
    - **リソース グループ**: *リソースと同じリソースグループ*
    - **リージョン**: *Azure Cognitive Searchリソースと同じ場所*
    - **名前**: *一意の名前を入力します*
    - **価格レベル**: Standard S0
2. 必要なチェックボックスを選択して、リソースを作成します。
3. デプロイが完了するのを待ってから、デプロイの詳細を表示します。

### ストレージ アカウントを作成する

1. Azure portalの 「ホーム」 ページに戻り、**&#65291;「リソースの作成」** ボタンを選択し、*ストレージ アカウント*を検索して、次の設定で**ストレージ アカウント** リソースを作成します。
    - **サブスクリプション**: *お使いの Azure サブスクリプション*
    - **リソース グループ**: * *Azure Cognitive Search および Cognitive Services リソースと同じリソースグループ*
    - **ストレージ アカウント名**: *一意の名前を入力します*
    - **リージョン**: *利用可能な任意のリージョンを選択します*
    - **パフォーマンス**: 標準
    - **レプリケーション**: ローカル冗長ストレージ (LRS)
2. デプロイが完了するのを待ってから、デプロイされたリソースに移動します。
3. **「概要」** ページで、**サブスクリプション ID** に注意してください。これはストレージ アカウントがプロビジョニングされているサブスクリプションを識別します。
4. **「アクセスキー」** ページで、ストレージ アカウント用に 2 つのキーが生成されていることに注意してください。次に、**「キーの表示」** を選択してキーを表示します。

    > **ヒント**: **ストレージ アカウント** ブレードを開いたままにします。次の手順では、サブスクリプション ID とキーの 1 つが必要になります。

## ドキュメントを Azure Storage にアップロードする

必要なリソースが揃ったので、いくつかのドキュメントを　Azure　Storage　アカウントにアップロードできます。

1. Visual Studio Code　の　**「エクスプローラー」** ペインで、**22-create-a-search-solution** フォルダーを展開し、**UploadDocs.cmd** を選択します。
2. バッチファイルを編集して、**YOUR_SUBSCRIPTION_ID**、**YOUR_AZURE_STORAGE_ACCOUNT_NAME**、および　**YOUR_AZURE_STORAGE_KEY** プレースホルダーを、以前に作成したストレージ アカウントの適切なサブスクリプション ID、Azure ストレージ アカウント名、および Azure ストレージアカウント キーの値に置き換えます。
3. 変更を保存してから、**22-create-a-search-solution** フォルダーを右クリックして、統合ターミナルを開きます。
4. 次のコマンドを入力して、Azure CLI を使用して Azure サブスクリプションにサインインします。

    ```
    az login
    ```

Web ブラウザーのタブが開き、Azure にサインインするように求められます。そうしてから、ブラウザー タブを閉じて、Visual Studio Code に戻ります。

5. 次のコマンドを入力して、バッチファイルを実行します。これにより、ストレージ アカウントに BLOB コンテナーが作成され、**データ** フォルダー内のドキュメントがそこにアップロードされます。

    ```
    UploadDocs
    ```

## ドキュメントのインデックス作成

ドキュメントが配置されたので、インデックスを作成して検索ソリューションを作成できます。

1. Azure portalで、Azure Cognitive　Search　リソースを参照します。次に、**「概要」**　ページで、**「データのインポート」**　を選択します。
2. **「データへの接続」**　ページの　**「データ ソース」**　リストで、　**「Azure Blob　Storage」**　を選択します。次に、次の値を使用してデータ ストアの詳細を入力します。
    - **データ ソース**: Azure Blob Storage
    - **データソース名**: margies-data
    - **抽出データ**: コンテンツとメタデータ
    - **解析モード**: 既定
    - **接続文字列**: ***「既存の接続を選択」** を選択します。次に、ストレージアカウントを選択し、最後に UploadDocs.cmd スクリプトによって作成された **margies** コンテナーを選択します。*
    - **Azure マネージド ID を使用して認証する**: 未選択
    - **コンテナ名**: margies
    - **Blob フォルダー**: *これは空白のままにします*
    - **説明**: Margie's Travel の Web サイトのパンフレットとレビュー。
3. 次のステップに進みます (*コグニティブスキルを追加します*)。
4. **「Cognitive Services のアタッチ」** セクションで、Cognitive Services リソースを選択します。
5. **「エンリッチメントの追加」** セクションで、次の手順を行います。
    - **スキルセット名**を　**margies-skillset**　に変更します。
    - **「OCR を有効にし、すべてのテキストを merged_content フィールドにマージする」** オプションを選択します。
    - **ソース　データ　フィールド**が　**merged_content**　に設定されていることを確認します。
    - **「エンリッチメントの粒度レベル」** を **「ソース フィールド」** のままにします。このフィールドには、インデックスを作成するドキュメントのコンテンツ全体が設定されます。ただし、これを変更して、ページや文など、より詳細なレベルで情報を抽出できることに注意してください。
    - 以下のエンリッチメント フィールドを選択します。

        | Cognitive Skill | パラメーター | フィールド名 |
        | --------------- | ---------- | ---------- |
        | 場所の名前の抽出 | | locations |
        | キー フレーズを抽出 | | keyphrases |
        | 言語の検出 | | language |
        | 画像からタグを生成 | | imageTags |
        | 画像からキャプションを生成 | | imageCaption |

6. (後で変更することが困難な場合があるため)、選択をダブルチェックします。次に、次のステップ (*ターゲット インデックスのカスタマイズ*) に進みます。
7. **インデックス名**を **margies-index** に変更します。
8. **キー**が **metadata_storage_path** に設定されていることを確認し、**サジェスタ名**と**検索モード**を空白のままにします。
9. インデックス フィールドに次の変更を加え、他のすべてのフィールドはデフォルト設定のままにします (**重要**: テーブル全体を表示するには、右にスクロールする必要がある場合があります)

    | フィールド名 | 取得可能 | フィルター可能 | ソート可能 | ファセット可能 | 検索可能 |
    | ---------- | ----------- | ---------- | -------- | --------- | ---------- |
    | metadata_storage_size | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#10004; | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#10004; | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#10004; | | |
    | metadata_storage_last_modified | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#10004; | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#10004; | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#10004; | | |
    | metadata_storage_name | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#10004; | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#10004; | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#10004; | | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#10004; |
    | metadata_author | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#10004; | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#10004; | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#10004; | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#10004; | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#10004; |
    | locations | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#10004;  | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#10004;  | | | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#10004; |
    | keyphrases | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#10004;  | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#10004;  | | | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#10004; |
    | language | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#10004;  | &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&#10004; | | | |

11. 選択内容を再確認し、特に注意して、各フィールドで正しい**取得可能**、**フィルター可能**、**ソート可能**、**ファセット可能**、および**検索可能**オプションが選択されていることを確認します (後で変更するのは難しい場合があります)。次に、次の手順 (*インデクサーの作成*) に進みます。
12. **インデクサー名**を　**margies-indexer**に変更します。
13. **スケジュール**は **1 回**に設定したままにします。
14. **「詳細」** オプションを展開し、**「Base-64 エンコード キー」** オプションが選択されていることを確認します (通常、キーをエンコードするとインデックスがより効率的になります)。
15. **「送信」** を選択して、データ ソース、スキルセット、インデックス、およびインデクサーを作成します。インデクサーは自動的に実行され、インデックス作成パイプラインを実行します。これ
    1. データソースからドキュメント メタデータ フィールドとコンテンツを抽出します
    2. コグニティブ スキルのスキルセットを実行して、追加の強化フィールドを生成します
    3. 抽出されたフィールドをインデックスにマップします。
16. Azure Cognitive Searc　hリソースの　**「概要」**　ページの下半分で、**「インデクサー」** タブを表示します。このタブには、新しく作成された **margies-indexer**が表示されます。数分待ってから、**「ステータス」** が成功を示すまで **「更新」** をクリックします。

## インデックスを検索する

インデックスができたので、検索できます。

1. Azure Cognitive Search リソースの **「概要」** ページの上部で、**「検索エクスプローラー」** を選択します。
2. 検索エクスプローラーの **「クエリ文字列」** ボックスに`*` (単一のアスタリスク) と入力し、**「検索」** を選択します。

    このクエリは、インデックス内のすべてのドキュメントを JSON 形式で取得します。結果を調べて、選択した認知スキルによって抽出されたドキュメント コンテンツ、メタデータ、および強化されたデータを含む各ドキュメントのフィールドをメモします。

3. クエリ文字列を`search=*&$count=true`に変更し、検索を送信します。

    今回の結果には、検索によって返されたドキュメントの数を示す　**@odata.count** フィールドが結果の上部に含まれています。

4. 次のクエリ文字列を試してください：

    ```
    search=*&$count=true&$select=metadata_storage_name,metadata_author,locations
    ```

    今回の結果には、ファイル名、作成者、およびドキュメントの内容に記載されている場所のみが含まれます。ファイル名と作成者は、ソースドキュメントから抽出された　**metadata_storage_name**　フィールドと　**metadata_author**　フィールドにあります。**「locations」** フィールドは、コグニティブスキルによって生成されました。

5. 次に、次のクエリ文字列を試してください。

    ```
    search="New York"&$count=true&$select=metadata_storage_name,keyphrases
    ```

    この検索では、検索可能なフィールドのいずれかで「ニューヨーク」に言及しているドキュメントが検索され、ドキュメント内のファイル名とキーフレーズが返されます。

6. もう 1 つのクエリ文字列を試してみましょう。

    ```
    search="New York"&$count=true&$select=metadata_storage_name&$filter=metadata_author eq 'Reviewer'
    ```

    このクエリは、「ニューヨーク」に言及している*レビューア*によって作成されたドキュメントのファイル名を返します。

## 検索コンポーネント定義の調査と変更

検索ソリューションのコンポーネントは、Azure portal　で表示および編集できる　JSON　定義に基づいています。

ポータルを使用して検索ソリューションを作成および変更できますが、検索オブジェクトを JSON で定義し、Azure Cognitive Service REST インターフェイスを使用してそれらを作成および変更することが望ましい場合がよくあります。

### Azure Cognitive Search リソースのエンドポイントとキーを取得する

1. Azure portal で、Azure CognitiveSearchリソースの **「概要」** ページに戻ります。ページの上部で、リソースの　**URL** (**https://resource_name.search.windows.net** のようになります) を見つけてクリップボードにコピーします。
2. Visual Studio Code の 「エクスプローラー」 ペインで、**22-create-a-search-solution** フォルダーとその **modify-search** サブフォルダーを展開し、**modify-search.cmd** を選択して開きます。このスクリプト ファイルを使用して、JSON を Azure Cognitive Service REST インターフェイスに送信する *cURL* コマンドを実行します。
3. **modify-search.cmd** で、**YOUR_SEARCH_URL** プレースホルダーをクリップボードにコピーした URL に置き換えます。
4. Azure portal で、Azure Cognitive Search リソースの **「キー」** ページを表示し、**プライマリ管理者キー**をクリップボードにコピーします。
5. Visual Studio Code で、**YOUR_ADMIN_KEY** プレースホルダーをクリップボードにコピーしたキーに置き換えます。
6. 変更を **modify-search.cmd** に保存します (ただし、まだ実行しないでください)。

### スキルセットを確認および変更する

1. Visual studio Code　の　**modify-search**　フォルダーで、s**skillset.json**　を開きます。これは、**margies-skillset**　の　JSON　定義を示しています。
2. スキルセット定義の上部にある　**cognitiveServices**　オブジェクトに注意してください。このオブジェクトは、Cognitive　Services　リソースをスキルセットに接続するために使用されます。
3. Azure portal　で、Cognitive Services　リソース (Azure Cognitive Search リソースではあり<u>ません</u>。) を開き、その**キー** ページを表示します。次に、**キー 1** をクリップボードにコピーします。
4. Visual Studio Code の **skillset.json** で、**YOUR_COGNITIVE_SERVICES_KEY** プレースホルダーをクリップボードにコピーした Cognitive Services キーに置き換えます。
5. JSON ファイルをスクロールして、Azure portal の Azure Cognitive Search ユーザー インターフェイスを使用して作成したスキルの定義が含まれていることに注意してください。スキルのリストの下部に、次の定義で追加のスキルが追加されました。

    ```
    {
        "@odata.type": "#Microsoft.Skills.Text.SentimentSkill",
        "defaultLanguageCode": "en",
        "name": "get-sentiment",
        "description": "New skill to evaluate sentiment",
        "context": "/document",
        "inputs": [
            {
                "name": "text",
                "source": "/document/merged_content"
            },
            {
                "name": "languageCode",
                "source": "/document/language"
            }
        ],
        "outputs": [
            {
                "name": "score",
                "targetName": "sentimentScore"
            }
        ]
    }
    ```

新しいスキルは **get-sentiment** という名前で、ドキュメント内の**ドキュメント** レベルごとに、インデックスが作成されているドキュメントの **merged_content** フィールドで見つかったテキストを評価します (これには、ソース コンテンツと、コンテンツ内の画像から抽出されたテキストが含まれます)。ドキュメントの抽出された**言語** (既定は英語) を使用し、コンテンツの感情のスコアを評価します。このスコアは、**sentimentScore** という名前の新しいフィールドとして出力されます。

6. **skillset.json** に加えた変更を保存します。

### インデックスを確認して変更する

1. VisualStudio Code の **modify-search** フォルダーで、**index.json** を開きます。これは、**margies-index** の JSON定義を示しています。
2. インデックスをスクロールして、フィールド定義を表示します。一部のフィールドはソースドキュメントのメタデータとコンテンツに基づいており、その他のフィールドはスキルセットのスキルの結果です。
3. Azure portal で定義したフィールドのリストの最後に、2 つのフィールドが追加されていることに注意してください

    ```
    {
        "name": "sentiment",
        "type": "Edm.Double",
        "facetable": false,
        "filterable": true,
        "retrievable": true,
        "sortable": true
    },
    {
        "name": "url",
        "type": "Edm.String",
        "facetable": false,
        "filterable": true,
        "retrievable": true,
        "searchable": false,
        "sortable": false
    }
    ```

4. **sentiment** フィールドは、スキルセットが追加された **get-sentiment** スキルからの出力を追加するために使用されます。**url**l フィールドは、データソースから抽出された **metadata_storage_path** 値に基づいて、インデックス付けされた各ドキュメントの URL をインデックスに追加するために使用されます。インデックスにはすでに **metadata_storage_path** フィールドが含まれていますが、インデックス キーとして使用され、Base-64 でエンコードされているため、キーとして効率的ですが、実際のURL値をフィールドとして使用する場合は、クライアント アプリケーションでデコードする必要があります。エンコードされていない値に2番目のフィールドを追加すると、この問題が解決します。

### インデクサーを確認して変更する

1. Visual Studio Code の **modify-search** フォルダーで、**indexer.json** を開きます。これは、**margies-indexer** の JSON 定義を示しています。これは、ドキュメントのコンテンツとメタデータから抽出されたフィールド (**fieldMappings**) セクションと、スキルセットのスキルによって抽出された値 (**outputFieldMappings**) をインデックスのフィールドにマップします。
3. **fieldMappings** リストで、**metadata_storage_path** 値の base-64 エンコード キー フィールドへのマッピングに注意してください。これは、**metadata_storage_path** をキーとして割り当て、Azure portal でキーをエンコードするオプションを選択したときに作成されました。さらに、新しいマッピングは、同じ値を **url** フィールドに明示的にマップしますが、Base-64 エンコーディングは使用しません。

    ```
    {
        "sourceFieldName" : "metadata_storage_path",
        "targetFieldName" : "url"
    }
    
    ```

ソース ドキュメント内の他のすべてのメタデータおよびコンテンツ フィールド インデックス内の同じ名前のフィールドに暗黙的にマップされます。

4. スキルセットのスキルからの出力をインデックス フィールドにマップする **ouputFieldMappings** セクションを確認します。これらのほとんどは、ユーザーインターフェイスで行った選択を反映していますが、感情スキルによって抽出された **sentimentScore** 値を、インデックスに追加した **sentiment** フィールドにマッピングするために、次のマッピングが追加されています。

    ```
    {
        "sourceFieldName": "/document/sentimentScore",
        "targetFieldName": "sentiment"
    }
    ```

### REST API を使用して検索ソリューションを更新する

1. **modify-search**　フォルダーを右クリックして、統合ターミナルを開きます。
2. **modify-search**　フォルダーのターミナル　ペインで、次のコマンドを入力して、**modify-search.cmd**　スクリプトを実行します。このスクリプトは、JSON　定義　をRES　Tインターフェースに送信し、インデックス作成を開始します。

    ```
    modify-search
    ```

3. スクリプトが終了したら、Azure portal　の　Azure Cognitive Search　リソースの　「**概要」** () ページに戻り、**「インデクサー」**　ページを表示します。定期的に **「更新**」 を選択して、インデックス作成操作の進行状況を追跡します。完了するまでに 1 分ほどかかる場合があります。

    *感情を評価するには大きすぎるいくつかのドキュメントに対して、いくつかの警告がある場合があります。多くの場合、感情分析は、ドキュメント全体ではなく、ページまたは文レベルで実行されます。ただし、この場合のシナリオでは、ほとんどのドキュメント（特にホテルのレビュー）は、有用なドキュメントレベルの感情スコアを評価するのに十分なほど短いものです。*

### 変更されたインデックスをクエリする

1. Azure Cognitive Search リソースのブレードの上部で、**「検索エクスプローラー」** を選択します。
2. 検索エクスプローラーの **「クエリ文字列」** ボックスに、次のクエリ文字列を入力し、**「検索」** を選択します。

    ```
    search=London&$select=url,sentiment,keyphrases&$filter=metadata_author eq 'Reviewer' and sentiment gt 0.5
    ```

    このクエリは、*レビュー担当者*が作成したロンドンに言及している、**感情スコア**が *0.5* を超えるすべてのドキュメント (つまり、*ロンドン*に言及している肯定的なレビュー) の **url**、**感情**、および**キーフレーズ**を取得します。

3. **検索エクスプローラー** ページを閉じて、**概要** ページに戻ります。

## 検索クライアント アプリケーションを作成する

有用なインデックスができたので、クライアント アプリケーションからそれを使用できます。これを行うには、REST インターフェイスを使用し、要求を送信し、HTTP　を介して　JSO　N形式で応答を受信します。または、お好みのプログラミング言語用のソフトウェア開発キット (SDK) を使用することもできます。この演習では、SDK を使用します。

> **注**: **C#** または **Python** 用の SDK のいずれかに使用することを選択できます。以下の手順で、希望する言語に適したアクションを実行します。

### 検索リソースのエンドポイントとキーを取得する

1. Azure portal　の　Azure　Cognitive Search　リソースの　**「概要」**　ページで、**https://*your_resource_name*.search.windows.net** のような **Url** 値に注意してください。これは、検索リソースのエンドポイントです。
2. **「キー」** ページで、2 つの**管理者**キーと 1 つの**クエリ** キーがあることに注意してください。*管理者*キーは、検索リソースを作成および管理するために使用されます。*クエリ* キーは、検索クエリを実行するだけでよいクライアント アプリケーションによって使用されます。

    *クライアントアプリケーションのエンドポイントとクエリキーが必要になります。*

### Azure Cognitive Search SDK を使用するための準備

1. Visual Studio Code の **「エクスプローラー」** ペインで、**22-create-a-search-solution** フォルダーを参照し、言語の設定に応じて **C-Sharp** フォルダーまたは **Python** フォルダーを展開します。
2. **margies-travel** フォルダーを右クリックして、統合ターミナルを開きます。次に、言語設定に適したコマンドを実行して、Azure Cognitive Search SDK パッケージをインストールします。

    **C#**
    
    ```
    dotnet add package Azure.Search.Documents --version 11.1.1
    ```
    
    **Python**
    
    ```
    pip install azure-search-documents==11.0.0
    ```
    
3. **margies-travel** フォルダーの内容を表示し、構成設定用のファイルが含まれていることに注意してください
    - **C#**: appsettings.json
    - **Python**: .env

    構成ファイルを開き、含まれている構成値を更新して、Azure Cognitive Search リソースの**エンドポイント**と**クエリ キー**を反映します。変更を保存します。

### インデックスを検索するためのコードの探索

**margies-travel** フォルダーには、検索機能を含む Web アプリケーション (Microsoft C# *ASP.NET Razor* Web アプリケーションまたはPython F*Flask* アプリケーション) のコード ファイルが含まれています。

1. 選択したプログラミング言語に応じて、次のコードファイルを Web アプリケーションで開きます
    - **C#**:Pages/Index.cshtml.cs
    - **Python**: app.py
2. コード ファイルの上部にあるコメント「**Import search namespaces**」を見つけ、Azure Cognitive Search　SDK　で機能するようにインポートされた名前空間をメモします。
3. **search_query**　関数で、コメント　**search_query**　を見つけ、コードが　Azure Cognitive　Search　リソースのエンドポイントとクエリ　キーを使用して　**SearchClient**　オブジェクトを作成することに注意してください
4. **search_query** 関数、コメント「**Submit search query**」を検索し、コードを確認して、次のオプションを使用して、指定されたテキストの検索を送信します
    - 検索テキスト内の個々の単語を**すべて**必要とする*検索モード*が見つかりました。
    - 検索で見つかったドキュメントの総数が結果に含まれます。
    - 結果は、提供されたフィルター式に一致するドキュメントのみを含むようにフィルター処理されます。
    - 結果は、指定された並べ替え順序に並べ替えられます。
    - **metadata_author**　フィールドの各離散値は、フィルタリング用の事前定義された値を表示するために使用できるa *ファセット*として返されます。
    - 検索語が強調表示された **merged_content** フィールドと　**imageCaption** フィールドの最大 3 つの抽出が結果に含まれます。
    - 結果には、指定されたフィールドのみが含まれます。

### 検索結果をレンダリングするためのコードを探索する

Web アプリには、検索結果を処理およびレンダリングするためのコードが既に含まれています。

1. 選択したプログラミング言語に応じて、次のコードファイルを Web アプリケーションで開きます
    - **C#**:Pages/Index.cshtml
    - **Python**: templates/search.html
2. コードを調べて、検索結果が表示されるページをレンダリングします。次の点に注意してください。
    - ページは、ユーザーが新しい検索を送信するために使用できる検索フォームで始まります (Python バージョンのアプリケーションでは、このフォームは **base.html** テンプレートで定義されています)。これはページの先頭で参照されます。
    - 次に、2 番目のフォームがレンダリングされ、ユーザーは検索結果を絞り込むことができます。このフォームのコードは、次の通りです。
        - 検索結果からドキュメントの数を取得して表示します。
        - **metadata_author** フィールドのファセット値を取得し、フィルタリングのオプションリストとして表示します。
        - 結果の並べ替えオプションのドロップダウンリストを作成します。
    - 次に、コードは検索結果を反復処理し、各結果を次のようにレンダリングします。
        - ます。**metadata_storage_name**(ファイル名) フィールドを、**url** フィールドのアドレスへのリンクとして表示します。
        - **merged_content** フィールドと **imageCaption** フィールドで見つかった検索用語の*ハイライト*表示して、コンテキストで検索用語を表示しやすくします。
        - **metadata_author**、**metadata_storage_size**、**metadata_storage_last_modified**、およびd **language** フィールドを表示します。
        - 絵文字を使用して**感情**を示します (スコアが 0.5 以上の場合は &#128578; 、スコアが 0.5 未満の場合は &#128577; )。
        - 最初の 5 つの**キーフレーズ** (ある場合) を表示します。
        - 最初の 5 つの**場所** (ある場合) を表示します。
        - 最初の 5 つの **imageTags**を表示します　(存在する場合)。

### Web アプリを実行する

 1. **margies-travel** フォルダーの統合ターミナルに戻り、次のコマンドを入力してプログラムを実行します。

    **C#**
    
    ```
    dotnet run
    ```
    
    **Python**
    
    ```
    flask run
    ```

2. アプリが正常に起動したときに表示されるメッセージで、実行中の Web アプリケーション (*http://localhost:5000/* または*http://127.0.0.1:5000/*) へのリンクをたどって、Webブラウザで Margies Travel サイトを開きます。
3. Margie's Travelの Web サイトで、検索ボックスに **London hotel** と入力し、**「検索」**　をクリックします。
4. 検索結果を確認します。これらには、ファイル名 (ファイル URL へのハイパーリンク付き)、検索語 (*London* および *hotel*) が強調されたファイル コンテンツの抽出、およびインデックス フィールドからのファイルの他の属性が含まれます。
5. 結果ページには、結果を絞り込むことができるいくつかのユーザーインターフェイス要素が含まれていることに注意してください。これらには以下が含まれます。
    - **metadata_author**　フィールドのファセット値に基づく*フィルター*。これは、*ファセット* フィールドを使用して、ユーザー インターフェイスで潜在的なフィルター値として表示できる離散値の小さなセットを含む*ファセット* -  フィールドのリストを返す方法を示しています。
    - 指定されたフィールドと並べ替え方向（昇順または降順）に基づいて結果を*並べ替える*機能。既定の順序は*関連性*に基づいており、インデックス　フィールドの検索用語の頻度と重要性を評価する*スコアリング プロファイル*に基づいて　**search.score()** 値として計算されます。
6. **レビューア** フィルターと 「**ポジティブからネガティブへ**の並べ替え」 オプションを選択し、**「結果の絞り込み」を選択します。**
7. 結果がレビューのみを含むようにフィルタリングされ、感情の降順で並べ替えられていることを確認します。
8. **「検索」** ボックスに、「**quiet hotel in New York**」の新しい検索を入力して、結果を確認します。
9. 次の検索用語を試してください。
    - **Tower of London** (この用語が一部のドキュメントで*キー フレーズ*として識別されていることに注意してください)。
    - **skyscraper** (この単語はどのドキュメントの実際のコンテンツにも表示されませんが、一部のドキュメントの画像用に生成された*画像のキャプション*と*画像タグ*に含まれていることに注意してください)。
    - **Mojave desert** (この用語が一部のドキュメントで*場所*として識別されていることに注意してください)。
10. Margie's Travel Web サイトを含むブラウザータブを閉じて、Visual Studio　Codeに戻ります。次に、**margies-travel** フォルダー　(dotnet または flask アプリケーションが実行されている) の Python ターミナルで、Ctrl+C を入力してアプリを停止します。

## 詳細

Azure Cognitive Search の詳細については、[Azure Cognitive Searchのドキュメントを](https://docs.microsoft.com/azure/search/search-what-is-azure-search)参照してください。
