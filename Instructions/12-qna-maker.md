---
lab:
  title: 質問応答ソリューションを作成する
  module: Module 6 - Building a QnA Solution
---

# <a name="create-a-question-answering-solution"></a>質問応答ソリューションを作成する

最も一般的な会話シナリオの 1 つは、よくある質問 (FAQ) のナレッジ ベースを通じてサポートを提供することです。 多くの組織は、FAQ をドキュメントまたは Web ページとして公開しています。これは、質問と回答のペアの小さなセットに適していますが、大きなドキュメントは検索が難しく、時間がかかる場合があります。

**Language** サービスには、*質問応答* 機能が含まれており、これを使用すると、自然言語で入力してクエリを実行できる、質問と回答のペアで構成されるナレッジ ベースを作成でき、ボットがユーザーから送信された質問への回答を検索するために使用できるリソースとして最も一般的に使用されます。

> **注**:言語サービスの質問応答機能は新しいバージョンの QnA Maker サービスであり、個別のサービスとして引き続き利用できます。

## <a name="clone-the-repository-for-this-course"></a>このコースのリポジトリを複製する

このラボで作業している環境に **AI-102-AIEngineer** コードのリポジトリをまだクローンしていない場合は、次の手順に従ってクローンします。 それ以外の場合は、複製されたフォルダーを Visual Studio Code で開きます。

1. Visual Studio Code を起動します。
2. パレットを開き (SHIFT+CTRL+P)、**Git:Clone** コマンドを実行して、`https://github.com/MicrosoftLearning/AI-102-AIEngineer` リポジトリをローカル フォルダーに複製します (どのフォルダーでも問題ありません)。
3. リポジトリを複製したら、Visual Studio Code でフォルダーを開きます。
4. リポジトリ内の C# コード プロジェクトをサポートするために追加のファイルがインストールされるまで待ちます。

    > **注**: ビルドとデバッグに必要なアセットを追加するように求めるダイアログが表示された場合は、 **[今はしない]** を選択します。

## <a name="create-a-language-resource"></a>"言語" リソースを作成する

質問に答えるナレッジ ベースを作成してホストするには、Azure サブスクリプションに **Language** サービス リソースが必要です。

1. Azure portal (`https://portal.azure.com`) を開き、ご利用の Azure サブスクリプションに関連付けられている Microsoft アカウントを使用してサインインします。
2. **[&#65291;リソースの作成]** ボタンを選択し、*Language* を検索して、**Language サービス** リソースを作成します。
3. **[カスタム質問応答]** ブロックで **[選択]** をクリックします。 次に、**[リソースの作成を続行する]** をクリックします。 次の設定を入力する必要があります。
    
    - **[サブスクリプション]**:"*ご自身の Azure サブスクリプション*"
    - **リソース グループ**: *リソース グループを選択または作成します (制限付きサブスクリプションを使用している場合は、新しいリソース グループを作成する権限がないことがあります。提供されているものを使ってください)*
    - **[リージョン]** : "*利用可能な場所を選択する*"
    - **[名前]**: *一意の名前を入力します*
    - **[価格レベル]**: Standard 5
    - **Azure 検索の場所**\*:"*言語リソースと同じグローバル リージョン内の場所を選択します*"。
    - **Azure Search の価格レベル**：無料 (F) ("*このレベルが利用できない場合は、[基本 (B)] を選択してください*")
    - **法的条項**: "同意"__ 
    - **責任ある AI 通知**: "同意"__
    
    \*カスタム質問応答は、Azure Search を使用して、質問と回答のナレッジ ベースにインデックスを付けてクエリを実行します。

4. デプロイが完了するまで待ち、デプロイの詳細を表示します。

## <a name="create-a-question-answering-project"></a>質問応答プロジェクトを作成する

言語リソースに質問応答のナレッジ ベースを作成するには、Language Studio ポータルを使用して質問応答プロジェクトを作成します。 この場合、[Microsoft Learn](https://docs.microsoft.com/learn) に関する質問と答えを含むナレッジ ベースを作成します。

1. 新しいブラウザー タブで *Language Studio* ポータル (`https://language.azure.com`) に移動し、ご利用の Azure サブスクリプションに関連付けられている Microsoft アカウントを使ってサインインします。
2. 言語リソースの選択を求めるメッセージが表示されたら、次の設定を選択します。
    - **Azure ディレクトリ**: ご利用のサブスクリプションを含む Azure ディレクトリ
    - **Azure サブスクリプション**: ご利用の Azure サブスクリプション
    - **言語リソース**: 先ほど作成した言語リソース。
3. 言語リソースの選択を求めるメッセージが表示<u>されない</u>場合、原因として、お使いのサブスクリプションに複数の言語リソースが存在していることが考えられます。その場合は、次の操作を行います。
    1. ページの上部にあるバーで、**[設定] (&#9881;)** ボタンをクリックします。
    2. **[設定]** ページで、**[リソース]** タブを表示します。
    3. 作成したばかりの言語リソースを選択し、**[リソースの切り替え]** をクリックします。
    4. ページの上部で、**[Language Studio]** をクリックして、Language Studio のホーム ページに戻ります。
3. ポータルの上部にある **[新規作成]** メニューで、 **[カスタム質問応答]** を選択します。
4. ***プロジェクトの作成**ウィザードの **[Choose language setting]\(言語設定の選択\)** ページで、このリソース内のすべてのプロジェクトの言語を設定するオプションを選択し、言語として **[英語]** を選択します。 続けて、 **[次へ]** をクリックします。
5. **[基本情報の入力]** ページで、次の詳細を入力したら、 **[次へ]** をクリックします。
    - **名前** LearnFAQ
    - **[説明]** : Microsoft Learn のよくあるご質問
    - **回答が返されない場合の既定の回答**: 申し訳ございません。質問がよくわかりませんでした
6. **[確認と終了]** ページで、**[プロジェクトの作成]** をクリックします。

## <a name="add-a-sources-to-the-knowledge-base"></a>ナレッジ ベースにソースを追加する

ナレッジ ベースは最初から作成できますが、既存の FAQ ページまたはドキュメントから質問と回答をインポートすることから始めるのが一般的です。 この場合、Microsoft Learn の既存の FAQ Web ページからデータをインポートし、一般的な会話のやり取りをサポートするために、あらかじめ定義された "おしゃべり" の質問と回答もインポートします。

1. 質問応答プロジェクトの **[ソースの管理]** ページにある **[&#9547; ソースの追加]** の一覧で、 **[URL]** を選択します。 次に、 **[URL の追加]** ダイアログ ボックスで **[&#9547; URL の追加]** をクリックし、次の URL を追加したら、 **[すべて追加]** をクリックしてナレッジ ベースに追加します。
    - **名前**: `Learn FAQ Page`
    - **URL**: `https://docs.microsoft.com/en-us/learn/support/faq`
2. 質問応答プロジェクトの **[ソースの管理]** ページで、 **[&#9547; ソースの追加]** の一覧にある **[Chitchat]\(おしゃべり\)** を選択します。 次に、 **[Add chit chat]\(おしゃべりの追加\)** ダイアログ ボックスで、 **[Friendly]\(フレンドリ\)** を選択し、 **[Add chit chat]\(おしゃべりの追加\)** をクリックします。

## <a name="edit-the-knowledge-base"></a>ナレッジ ベースを編集する

ナレッジ ベースには、Microsoft Learn FAQ の質問と回答のペアが入力されており、会話型 *chit-chat* の質問と回答のペアが追加されています。 質問と回答のペアを追加することで、ナレッジ ベースを拡張できます。

1. Language Studio の **[LearnFAQ]** プロジェクトで、 **[ナレッジ ベースの編集]** ページを選択して既存の質問と回答のペアを表示します (複数のヒントが表示されている場合は、それを読み、 **[了解]** をクリックして閉じるか、 **[すべてスキップ]** をクリックします)
2. ナレッジ ベースで、 **[&#65291; 質問のペアの追加]** を選択します。
3. **[質問]** ボックスに「`What is Microsoft certification?`」と入力し、**Enter**** キーを押します。
4. **[&#65291; 代替語句の追加]** を選択し、「`How can I demonstrate my Microsoft technology skills?`」と入力して **Enter** キーを押します。
5. **[回答]** ボックスに「`The Microsoft Certified Professional program enables you to validate and prove your skills with Microsoft technologies.`」と入力します。次に、 **[送信]** を押して質問 (代替フレージングを含む) と回答をナレッジ ベースに追加します。

    場合によっては、ユーザーが回答をフォローアップして、*複数ターン* 会話を作成できるようにすることが理にかなっています。ユーザーは、質問を繰り返し絞り込んで、必要な回答者にたどり着きます。

6. 認定の質問に入力した回答の下で、 **[&#65291; フォローアップ プロンプトの追加]** を選択します。
7. **[フォローアップ プロンプト]** ダイアログ ボックスで、次の設定を入力してから、 **[プロンプトの追加]** をクリックします。
    - **ユーザーへのプロンプトに表示されるテキスト**: `Learn more about certification`。
    - **[新しいペアへのリンクの作成]** を選択し、このテキストを入力します: `You can learn more about certification on the [Microsoft certification page](https://docs.microsoft.com/learn/certifications/).`
    - **コンテキスト フローでのみ表示**:オンにします。 *このオプションにより、元の認定質問からのフォローアップ質問のコンテキストでのみ回答が返されるようになります。*

## <a name="train-and-test-the-knowledge-base"></a>ナレッジ ベースのトレーニングとテスト

ナレッジベースができたので、Language Studio でテストできます。

1. 次に、ページの右上にある **[変更の保存]** をクリックします。
2. 変更が保存されたら、 **[テスト]** をクリックしてテスト ペインを開きます。
3. テスト ペインの上部にある、短い回答を表示するオプションの *選択を解除* します。 次に、下部に「`Hello`」というメッセージを入力します。 適切な応答が返される必要があります。
4. テスト ペインの下部に「`What is Microsoft Learn?`」というメッセージを入力します。 FAQ から適切な応答が返されるはずです。
5. 「`Thanks!`」というメッセージを入力します。適切なおしゃべりの応答が返されます。
6. 「`Tell me about certification`」というメッセージを入力します。 作成した回答が、フォローアップ プロンプト ボタンとともに返されます。
7. **[Learn more about certification]** ボタンを選択します。 認定ページへのリンクを含むフォローアップ回答を返送する必要があります。
8. ナレッジ ベースのテストが完了したら、テスト ペインを閉じます。

## <a name="deploy-and-test-the-knowledge-base"></a>ナレッジ ベースのデプロイとテスト

ナレッジ ベースは、クライアント アプリケーションが質問に回答するために使用できるバックエンド サービスを提供します。 これで、ナレッジ ベースを公開し、クライアントからその REST インターフェイスにアクセスする準備が整いました。

1. Language Studio で、**LearnFAQ** プロジェクトの **[ナレッジ ベースのデプロイ]** ページを選択します。
2. ページの上部にある **[デプロイ]** をクリックします。 次に、 **[デプロイ]** をクリックして、ナレッジ ベースをデプロイすることを確認します。
3. デプロイが完了したら、 **[予測 URL の取得]** をクリックしてナレッジ ベースの REST エンドポイントを表示し、それをクリップボードにコピーします (ただし、ダイアログ ボックスはまだ閉じないでください)。
4. Visual Studio Code で、**12-qna** フォルダーの **ask-question.cmd** を開きます。 このスクリプトでは、*Curl* を使用して、質問応答エンドポイントの REST インターフェイスを呼び出します。
5. スクリプトで、*YOUR_PREDICTION_ENDPOINT* をコピーした予測エンドポイントに置き換えます (必ず引用符で囲んでください)。
6. ブラウザーに戻り、 **[予測 URL の取得]** ダイアログ ボックスで、サンプルの要求に **Ocp-Apim-Subscription-Key** パラメーターの値が含まれていることを確認します。これは、*ab12c345de678fg9hijk01lmno2pqrs34* のようになります。 これはリソースの承認キーです。 それをクリップボードにコピーし、 **[OK]** をクリックしてダイアログ ボックスを閉じます。
7. Visual Studio Code に戻り、**ask-question.cmd** スクリプトの *YOUR_KEY* をコピーしたキーに置き換えます (必ず引用符で囲んでください)。
8. スクリプトの Curl コマンドによって、**What is a Learning Path?** (ラーニング パスとは何ですか) という値を持つ **question** パラメーターが送信されることに注意してください。
9. スクリプト全体が次のコードのようになっていることを確認し、ファイルを保存します。

    ```
    @echo off
    SETLOCAL ENABLEDELAYEDEXPANSION

    rem Set variables
    set prediction_url="https://some-name.cognitiveservices.azure.com/language/......."
    set key="ab12c345de678fg9hijk01lmno2pqrs34"

    curl -X POST !prediction_url! -H "Ocp-Apim-Subscription-Key: !key!" -H "Content-Type: application/json" -d "{'question': 'What is a learning Path?' }"
    ```

10. Visual Studio Code のエクスプローラー ペインで、**ask-question.cmd** スクリプトを右クリックし、 **[Open in Integrated Terminal]\(統合ターミナルで開く\)** を選択します。
11. ターミナル ペインで、スクリプトを実行するコマンド `ask-question.cmd` を入力し、サービスによって返された JSON 応答を表示します。これには、*What is a learning path?* という質問に対する適切な回答が含まれているはずです。

## <a name="create-a-bot-for-the-knowledge-base"></a>ナレッジ ベース用のボットを作成する

最も一般的には、ナレッジ ベースから回答を取得するために使用されるクライアント アプリケーションはボットです。

1. ブラウザーで Language Studio に戻り、 **[ナレッジ ベースのデプロイ]** ページで **[ボットの作成]** を選択します。 これにより、Azure portal が新しいブラウザー タブで開き、お使いの Azure サブスクリプションで Web アプリ ボットを作成できます (メッセージが表示されたら、サインインします)。
2. Azure portal で、次の設定で Web アプリ ボットを作成します (ほとんどの設定は事前入力されています)。

    *一部の値が欠落している場合は、ブラウザーを更新します。*  

  - **[ボット ハンドル]**: *ボットの一意の名前*
  - **[サブスクリプション]**:"*ご自身の Azure サブスクリプション*"
  - **[リソース グループ]** : "*言語リソースを含むリソース グループ*"
  - **[場所]** : *Text Analytics サービスと同じ場所*。
  - **[価格レベル]**: F0
  - **[アプリ名]** : ***ボット ハンドル** と同じで、一意の ID と *.azurewebsites.net* が自動的に追加されます
  - **[SDK 言語]**: *C# または Node.js を選択します*
  - **[QnA 認証キー]**: *これは、QnA ナレッジ ベースの認証キーに自動的に設定されます*
  - **アプリ サービス プラン/場所**:"*これは、適切なプランと場所が存在する場合は、自動的に設定されることがあります。それ以外の場合は、新しいプランを作成します*"
  - **[Application Insights]**: オフ
  - **[Microsoft アプリ ID とパスワード]**: アプリ ID とパスワードを自動作成します。
3. ボットが作成されるまで待ちます。 次に、 **[リソースに移動]** をクリックします (または、ホーム ページで **[リソース グループ]** をクリックし、Web アプリ ボットを作成したリソース グループを開いてクリックします)。
4. ボットのブレードで **[Web チャットでのテスト]** ページが表示され、ボットによって "**こんにちは、ようこそ!**" というメッセージが表示されるまで待ちます。 (初期化には数秒かかることがあります)。
5. テスト チャット インターフェイスを使用して、ボットがナレッジ ベースから期待どおりに質問に回答することを確認します。 たとえば、`What is Microsoft certification?` を送信してみます。

## <a name="more-information"></a>詳細情報

言語サービスの質問応答の詳細については、[言語サービスのドキュメント](https://docs.microsoft.com/en-us/azure/cognitive-services/language-service/question-answering/overview)に関するページを参照してください。
