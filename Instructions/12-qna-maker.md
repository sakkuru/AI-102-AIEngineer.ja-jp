---
lab:
  title: 質問応答ソリューションを作成する
  module: Module 6 - Building a QnA Solution
---

# <a name="create-a-question-answering-solution"></a>質問応答ソリューションを作成する

最も一般的な会話シナリオの 1 つは、よくある質問 (FAQ) のナレッジ ベースを通じてサポートを提供することです。多くの組織は、FAQ をドキュメントまたは Web ページとして公開しています。これは、質問と回答のペアの小さなセットに適していますが、大きなドキュメントは検索が難しく、時間がかかる場合があります。

**Language** サービスには、*質問応答* 機能が含まれており、これを使用すると、自然言語で入力してクエリを実行できる、質問と回答のペアで構成されるナレッジ ベースを作成でき、ボットがユーザーから送信された質問への回答を検索するために使用できるリソースとして最も一般的に使用されます。

> **注**:言語サービスの質問応答機能は新しいバージョンの QnA Maker サービスであり、個別のサービスとして引き続き利用できます。

## <a name="clone-the-repository-for-this-course"></a>このコースのリポジトリを複製する

AI-102-AIEngineer コードのリポジトリをこのラボで作業している環境にまだ複製していない場合は、次の手順に従って複製してください。それ以外の場合は、複製されたフォルダーを Visual Studio Code で開きます。

1. Visual Studio Code を起動します。
2. パレットを開き (SHIFT+CTRL+P)、**Git:Clone** コマンドを実行して、`https://github.com/MicrosoftLearning/AI-102-AIEngineer` リポジトリをローカル フォルダーに複製します (どのフォルダーでも問題ありません)。
3. リポジトリを複製したら、Visual Studio Code でフォルダーを開きます。
4. リポジトリ内の C# コード プロジェクトをサポートするために追加のファイルがインストールされるまで待ちます。

    > **注**: ビルドとデバッグに必要なアセットを追加するように求めるダイアログが表示された場合は、 **[今はしない]** を選択します。

## <a name="create-a-language-resource"></a>"言語" リソースを作成する

質問に答えるナレッジ ベースを作成してホストするには、Azure サブスクリプションに **Language** サービス リソースと、Azure Cognitive Searchリソースが必要です。

> 注: すでにLanguageリソースがある場合は、「機能」メニューから、Azure Cognitive Searchサービス リソースの作成と関連付けを行ってください。

1. Azure portal (`https://portal.azure.com`) を開き、ご利用の Azure サブスクリプションに関連付けられている Microsoft アカウントを使用してサインインします。
2. **[&#65291;リソースの作成]** ボタンを選択し、*Language* を検索して、**Language サービス** リソースを作成します。
3. 「カスタム質問応答（プレビュー）」ブロックで「選択」をクリックします。次に、「続行」をクリックして、リソースを作成します。次の設定を入力する必要があります。
    
    - **[サブスクリプション]**:*ご自身の Azure サブスクリプション*
    - **リソース グループ**: *リソース グループを選択または作成します (制限付きサブスクリプションを使用している場合は、新しいリソース グループを作成する権限がないことがあります。提供されているものを使ってください)*
    - **[リージョン]** : *利用可能な場所を選択する*
    - **[名前]**: *一意の名前を入力します*
    - **[価格レベル]**: Standard
    - **Azure 検索の場所**: *言語リソースと同じグローバル リージョン内の場所を選択します*
    - **Azure Search の価格レベル**：無料 (F) ("*このレベルが利用できない場合は、[基本 (B)] を選択してください*")
    - **責任ある AI 通知**: 同意
    
    \*カスタム質問応答は、Azure Search を使用して、質問と回答のナレッジ ベースにインデックスを付けてクエリを実行します。

4. デプロイが完了するまで待ち、デプロイの詳細を表示します。


## 質問と回答プロジェクトを作成する

言語リソースに質問と回答のナレッジ ベースを作成するには、Language Studio ポータルを使用して質問と回答プロジェクトを作成します。この場合、[Microsoft Learn](https://docs.microsoft.com/learn) に関する質問と回答を含むナレッジ ベースを作成します。

1. 新しいブラウザー タブで、`https://language.azure.com` の *Language Studio* ポータルにアクセスし、Azure サブスクリプションに関連付けられている Microsoft アカウントを使用してサインインします。
2. 言語リソースの選択を求められたら、次の設定を選択します。
    - **Azure ディレクトリ**: サブスクリプションを含む Azure ディレクトリ。
    - **Azure サブスクリプション**: Azure サブスクリプション。
    - **言語リソース**: 以前に作成した言語リソース。
3. 言語リソースの選択を促すメッセージが表示され <u>ない</u> 場合は、サブスクリプションに複数の言語リソースが含まれていることが考えられます。この場合は、以下の操作を行ってください。
    1. ページ上部のバーで、「**Settings (&#9881;)**」 (設定) ボタンをクリックします。
    2. 「**Settings**」 (設定) ページで「**Resources**」 (リソース) タブを選択します。
    3. 作成した言語リソースを選択し、「**Switch resource**」 (リソースの切り替え) をクリックします。
    4. ページ上部の「**Language Studio**」をクリックして、Language Studio のホーム ページに戻ります。
3. ポータルの上部にある「**Create new**」 (新規作成) メニューで、「**Custom question answering**」 (カスタム質問と回答) を選択します。
4. 「**プロジェクトの作成**」 ウィザードの「**Choose language setting** (言語設定の選択) ページで「このリソースのすべてのプロジェクトに言語を設定する」というオプションを選択し、言語として「**Japanese**」を選択します。次に、「**次へ**」をクリックします。
5. 「**Enter basic information**」 (基本情報の入力) ページで、次の詳細を入力してから「**Next**」 (次へ) をクリックします:
    - **名前** LearnFAQ
    - **説明**: Microsoft Learn FAQ
    - **応答が返されない場合の既定の回答**: 申し訳ありませんが、質問の意味がわかりませんでした。
6. 「**Review and finish** (確認と完了) ページで、「**Create project**」 (プロジェクトの作成) をクリックします。

## ナレッジ ベースにソースを追加する

ナレッジ ベースは最初から作成できますが、既存の FAQ ページまたはドキュメントから質問と回答をインポートすることから始めるのが一般的です。この場合、Microsoft Learn の既存の FAQ ページからデータをインポートし、一般的な会話のやり取りをサポートするために、あらかじめ定義された「chit chat」の質問と回答もインポートします。

1. 質問と回答プロジェクトの「**Manage sources**」 (ソースの管理) ページでは、「**&#9547; Add source**」 (ソースの追加）リストで、**URLs** を選択します。次に、「**Add URLs**」 ダイアログ ボックスで、「**&#9547; Add url**」(URLの追加) をクリックして、以下の URL を追加し、「**Add all**」 (すべて追加) をクリックして、ナレッジ ベースに追加します。
    - **名前**: `Learn FAQ Page`
    - **URL**: `https://docs.microsoft.com/ja-jp/learn/support/faq`
2. 質問と回答プロジェクトの「**Manage sources**」 (ソースの管理) ページでは、「**&#9547; Add source**」 (ソースの追加）リストで、**Chitchat（おしゃべり）** を選択します。次に、「**Add chit chat**」 (おしゃべりの追加) ダイアログ ボックスで、「**Friendly**」 (親しみやすい) を選択し、「**Add chit chat**」 (おしゃべりの追加) をクリックします。

## ナレッジ ベースを編集する

ナレッジ ベースには、Microsoft Learn FAQ の質問と回答のペアと、おしゃべりの質問と回答のペアが追加されています。質問と回答のペアを追加することで、ナレッジ ベースを拡張できます。

1. Language Studio の 「**LearnFAQ**」 プロジェクトで、「**Edit knowledge base**」 (ナレッジ ベースの編集) ページを選択し、既存の質問と回答のペアを確認し (複数のヒントが表示されている場合は、それを読み、「**Got it**」 (了解) をクリックして解除するか、「**Skip all**」 (すべてスキップ) をクリックします) 
2. ナレッジ ベースで「**&#65291; 質問のペアの追加**」を選択します。
3. 「**質問**」ボックスに`マイクロソフト認定資格とは何ですか？`と入力、**Enter** キーを押します。
4. 「**&#65291; 代替語句の追加**」 を選択し、`マイクロソフトの技術力をアピールするには？`と入力し、**Enter** キーを押します。
5. 「**回答**」 ボックスに、`マイクロソフト認定プロフェッショナルプログラムでは、マイクロソフトの技術を検証し、その技術を証明することができます。`と入力し、**Enter** キーを押して「**送信**」をクリックすると、質問 (代替フレージングを含む) と回答がナレッジ ベースに追加されます。

    場合によっては、ユーザーが回答をフォローアップして、*複数ターン* 会話を作成できるようにすることが理にかなっています。ユーザーは、質問を繰り返し絞り込んで、必要な回答者にたどり着きます。

6. 認定の質問に入力した回答の下で、 **[&#65291; フォローアップ プロンプトの追加]** を選択します。
7. **[フォローアップ プロンプト]** ダイアログ ボックスで、次の設定を入力してから、 **[プロンプトの追加]** をクリックします。
    - **ユーザーへのプロンプトに表示されるテキスト**: `認証について詳しくはこちら`。
    - **[新しいペアへのリンクの作成]** を選択し、このテキストを入力します: `認定資格については、[マイクロソフト認定資格のページ](https://docs.microsoft.com/learn/certifications/)で詳しく解説しています。`
    - **コンテキスト フローでのみ表示**:オンにします。 *このオプションにより、元の認定質問からのフォローアップ質問のコンテキストでのみ回答が返されるようになります。*


## ナレッジ ベースのトレーニングとテスト

ナレッジ ベースができたので、トレーニングとテストを行います。

1.  「**変更の保存**」をクリックします。
2. 変更内容が保存されたら、「**テスト**」をクリックしてテスト ペインを開きます。
3. 「テスト」ペインの上部で、短い回答を表示するオプションの「*選択を解除*」します。次に、「テスト」 ペインの下部に、`こんにちは`というメッセージを入力します。適切な応答が返される必要があります。
4. 「テスト」 ペインでは、一番下に`Microsoft Learnとは？`というメッセージを入力します。FAQ からの適切な応答が返される必要があります。￥
6. `認定について教えてください。`というメッセージを入力し、結果を確認します。


## ナレッジ ベースをデプロイしてテストする

ナレッジ ベースは、クライアント アプリケーションが質問に回答するために使用できるバックエンド サービスを提供します。これで、ナレッジ ベースを公開し、クライアントからその REST インターフェイスにアクセスする準備が整いました。

1. Language Studio の「**Learn FAQ**」 プロジェクトで、「**Deploy knowledge base**」 (ナレッジ ベースのデプロイ) ページを選択します。
2. ページの上部にある 「**Deploy**」 (デプロイ)をクリックします。その後、「**Deploy**」 (デプロイ)  をクリックして、ナレッジ ベースをデプロイすることを確認します。
3. デプロイが完了したら、 「**Get prediction URL**」 (Prediction URL の取得) をクリックしてナレッジ ベースの REST エンドポイントを表示し、クリップボードにコピーします（ただし、ダイアログ ボックスはまだ閉じないでください）。
4. Visual Studio Code の **12-qna** フォルダーで、**ask-question.cmd** を開きます。このスクリプトは、*Curl* を使用して、質問と応答エンドポイントの REST インターフェイスを呼び出します。
5. スクリプトの中で、*YOUR_PREDICTION_ENDPOINT* をコピーした予測エンドポイントに置き換えます（引用符で囲まれていることを確認してください）。
6. ブラウザーに戻り、**Get prediction URL**  (Prediction URL の取得) ダイアログ ボックスで、サンプルの要求に **Ocp-Apim-Subscription-Key** パラメーターの値が含まれていることに注意してください。 その値は *ab12c345de678fg9hijk01lmno2pqrs34* に似ています。これはリソースの認証キーです。クリップボードにコピーした後、「**Got it**」 (了解) をクリックしてダイアログ ボックスを閉じます。
7. Visual Studio Code に戻り、**ask-question.cmd** スクリプトで、*YOUR_KEY* をコピーしたキーに置き換えます (引用符で囲まれていることを確認してください)。
8. スクリプトの Curl コマンドは「**ラーニングパスとは？**」の値の **question**(質問) パラメーターを送信することに注意してください。
9. スクリプト全体が以下のコードのようになっていることを確認し、ファイルを保存します。

    ```
    @echo off
    SETLOCAL ENABLEDELAYEDEXPANSION

    rem Set variables
    set prediction_url="https://some-name.cognitiveservices.azure.com/language/......."
    set key="ab12c345de678fg9hijk01lmno2pqrs34"

    curl -X POST !prediction_url! -H "Ocp-Apim-Subscription-Key: !key!" -H "Content-Type: application/json" -d "{'question': 'ラーニングパスとは？' }"
    ```

10. Visual Studio Code の Explorer ペインで **ask-question.cmd** スクリプトを右クリックし、「**Open in Integrated Terminal**」.(統合ターミナルで開く) を選択します。
11. ターミナル ペインでコマンド `ask-question.cmd`  を入力してスクリプトを実行し、サービスから返される JSON 応答を確認します。この応答 には、ラーニングパスとは何かという質問に対する適切な回答を含んでいる必要があります。

## ナレッジ ベース用のボットを作成する

最も一般的には、ナレッジ ベースから回答を取得するために使用されるクライアント アプリケーションはボットです。

1. ブラウザーで Language Studio に戻り、「**Deploy knowledge base** (ナレッジ  ベースのデプロイ) ページで、「**Create Bot**」 (ボットの作成) を選択します。.これにより、新しいブラウザー タブで Azure portal が開き、Azure サブスクリプションで Web アプリ ボットを作成できます (プロンプトが表示されたら、サインインしてください)。
2. Azure portal で、次の設定を使用して Web アプリ ボットを作成します (これらのほとんどは事前に入力されています)。

    *一部の値が欠落している場合は、ブラウザーを更新します。*  

  - **ボット ハンドル**: *ボットの一意の名前*
  - **サブスクリプション**: *お使いの Azure サブスクリプション*
  - **リソース グループ**: *言語リソースを含むリソース グループ*
  - **場所**: *Language サービスと同じ場所*
  - **価格レベル**: F0
  - **アプリ名**: ***ボット ハンドル**と同じで、固有の ID と *[.azurewebsites.net]* が自動的に付加されています。
  - **SDK 言語**: *C# または Node.js のいずれかを選択*
  - **QnA 認証キー**: *これは、QnA ナレッジ ベースのの認証キーに自動的に設定されます。*
  - **アプリ サービス プラン/場所**: *これは、適切なプランと場所が存在する場合は、自動的に設定される場合があります。そうでない場合は、新しいプランを作成します*
  - **Application Insights**: オフ
  - **Microsoft アプリ ID とパスワード**: アプリ ID とパスワードを自動作成します。
3. ボットが作成されるのを待ちます。次に、「**Go to resource**」 (リソースに移動) (または、ホーム ページで、「**Resource groups** (リソース グループ)  をクリックし、Web アプリ ボットを作成したリソース グループを開いて、クリックします）。
4. ボットのブレードで、「**Test in Web Chat**」 (Web チャットでのテスト) ページを表示し、ボットが「**Hello and welcome!**」 (こんにちは、ようこそ) というメッセージを表示するまで待ちます。(初期化には数秒かかる場合があります)。
5. テスト チャット インターフェイスを使用して、ボットがナレッジ ベースからの質問に期待どおりに回答することを確認します。たとえば、`マイクロソフトの認定とは？`を送信してみてください。

## 詳細

Language サービスの質問と回答については、[Langauge サービスのドキュメント](https://docs.microsoft.com/en-us/azure/cognitive-services/language-service/question-answering/overview)を参照してください。
